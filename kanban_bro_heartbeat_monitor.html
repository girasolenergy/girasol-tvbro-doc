<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Kanban Bro Heartbeat Monitor</title>
    <style>
        .heartbeat_screenshot {
            max-width: 400px;
            max-height: 400px;
            border: 1px solid #ccc;
        }
        .heartbeat_settings
    </style>
</head>
<body>

<h1>Kanban Bro Heartbeat Monitor</h1>

<p>
    <button id="google-signin-button">Sign in</button>
    <button id="signout-button" style="display: none;">Sign out</button>
</p>

<p>User: <span id="user-status">-</span></p>

<div id="container"></div>

<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyDZrghHsrdUM6WN0ArOcIchEqn5y4bBZGk",
      authDomain: "kanbanbro.firebaseapp.com",
      projectId: "kanbanbro",
      storageBucket: "kanbanbro.firebasestorage.app",
      messagingSenderId: "716803851987",
      appId: "1:716803851987:web:0bcd6f8b2e8d7d0151f626",
      measurementId: "G-N3C4HWN670"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
</script>

<script>
    function also(element, block) {
        block(element);
        return element;
    }
</script>

<script type="module">
    import { getAuth, GoogleAuthProvider, onAuthStateChanged, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getStorage, ref, listAll, getDownloadURL, getBytes, getMetadata } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";

    const auth = getAuth();
    const storage = getStorage();

    onAuthStateChanged(auth, user => {
        new Promise(async () => {
            if (user) {
                document.getElementById('user-status').textContent = `UID: ${user.uid}`;
                document.getElementById('google-signin-button').style.display = 'none';
                document.getElementById('signout-button').style.display = 'inline-block';
                fetchAllHeartbeatData(user.uid);
            } else {
                document.getElementById('user-status').textContent = '-';
                document.getElementById('google-signin-button').style.display = 'inline-block';
                document.getElementById('signout-button').style.display = 'none';
            }
        });
    });

    document.getElementById('google-signin-button').addEventListener('click', async () => {
        const provider = new GoogleAuthProvider();
        let result;
        try {
            result = await signInWithPopup(auth, provider);
        } catch (error) {
            console.error("Failed to sign in", error);
            return;
        }
        console.log("Successfully signed in:", result.user.uid);
    });

    document.getElementById('signout-button').addEventListener('click', async () => {
        try {
            await signOut(auth);
        } catch (error) {
            console.error("Failed to sign out", error);
            return;
        }
        console.log("Successfully signed out.");
    });

    async function fetchAllHeartbeatData(uid) {
        const container = document.getElementById('container');
        container.innerHTML = '';
        const res = await listAll(ref(storage, `users/${uid}`));
        for (let folderRef of res.prefixes) {
            const [screenshot, settings, metadata] = await Promise.all([
                new Promise(async (callback) => {
                    let data;
                    try {
                        data = await getBytes(ref(folderRef, 'screenshot.png'));
                    } catch (error) {
                        console.error(`Failed to fetch screenshot: ${folderRef.name}/screenshot.png`, error);
                        return;
                    }
                    console.log(`Successfully fetched screenshot: ${folderRef.name}/screenshot.png`);
                    callback(URL.createObjectURL(new Blob([data], { type: 'image/png' })));
                }),
                new Promise(async (callback) => {
                    let data;
                    try {
                        data = await getBytes(ref(folderRef, 'settings.json'));
                    } catch (error) {
                        console.error(`Failed to fetch settings: ${folderRef.name}/settings.json`, error);
                        return;
                    }
                    console.log(`Successfully fetched settings: ${folderRef.name}/settings.json`);
                    callback(JSON.parse(new TextDecoder().decode(data)));
                }),
                new Promise(async (callback) => {
                    let metadata;
                    try {
                        metadata = await getMetadata(ref(folderRef, 'settings.json'));
                    } catch (error) {
                        console.error(`Failed to fetch metadata: ${folderRef.name}/settings.json`, error);
                        return;
                    }
                    console.log(`Successfully fetched metadata: ${folderRef.name}/settings.json`);
                    callback(metadata);
                }),
            ]);

            console.log(`Screenshot: ${screenshot}`);
            console.log(`Settings: ${JSON.stringify(settings, null, 2)}`);
            console.log(`Metadata: ${JSON.stringify(metadata, null, 2)}`);

            container.appendChild(also(document.createElement('div'), div => {
                div.appendChild(also(document.createElement('p'), titleP => {
                    titleP.textContent = settings.title ?? folderRef.name;
                    titleP.className = 'heartbeat_title';
                }));
                div.appendChild(also(document.createElement('img'), screenshotImg => {
                    screenshotImg.src = screenshot;
                    screenshotImg.className = 'heartbeat_screenshot';
                }));
                div.appendChild(also(document.createElement('pre'), settingsPre => {
                    settingsPre.textContent = metadata.updated;
                    settingsPre.className = 'heartbeat_settings';
                }));
            }));
        }
        console.log("Successfully fetched all heartbeat data.");
    }

</script>

</body>
</html>
